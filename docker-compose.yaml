                                                                                                                                                 
services:                                                                                                                                           
  # Zookeeper for Kafka                                                                                                                             
  zookeeper:                                                                                                                                        
    image: zookeeper:3.9                                                                                                                            
    container_name: zookeeper                                                                                                                       
    ports:                                                                                                                                          
      - "2181:2181"                                                                                                                                 
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
  # Kafka Broker                                                                                                                                    
  kafka:                                                                                                                                            
    image: apache/kafka:4.0.0                                                                                                                       
    container_name: kafka                                                                                                                           
    ports:                                                                                                                                          
      - "9092:9092"                                                                                                                                 
    environment:                                                                                                                                    
      KAFKA_BROKER_ID: 1                                                                                                                            
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092                                                                                                     
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092                                                                                            
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181                                                                                                       
    depends_on:                                                                                                                                     
      - zookeeper                                                                                                                                   
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
  # PostgreSQL Database (Shared by all services)                                                                                                    
  postgres-db:                                                                                                                                      
    image: postgres:13                                                                                                                              
    container_name: postgres-db                                                                                                                     
    environment:                                                                                                                                    
      POSTGRES_USER: postgres                                                                                                                       
      POSTGRES_PASSWORD: postgres                                                                                                                   
      POSTGRES_DB: myRoadAssistance                                                                                                                 
    ports:                                                                                                                                          
      - "5433:5432"                                                                                                                                 
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
  # Eureka Service Registry                                                                                                                         
  eureka-server:                                                                                                                                    
    build:                                                                                                                                          
      context: ./ServiceRegistry                                                                                                                    
      dockerfile: Dockerfile                                                                                                                        
    container_name: eureka-server                                                                                                                   
    ports:                                                                                                                                          
      - "8761:8761"                                                                                                                                 
    environment:                                                                                                                                    
      - eureka.client.registerWithEureka=false                                                                                                      
      - eureka.client.fetchRegistry=false                                                                                                           
      - eureka.server.enableSelfPreservation=false                                                                                                  
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
  # CollisionModule Microservice (Producer)                                                                                                         
  collisionmodule:                                                                                                                                  
    build:                                                                                                                                          
      context: ./Collision_Module                                                                                                                   
      dockerfile: Dockerfile                                                                                                                        
    container_name: collisionmodule                                                                                                                 
    ports:                                                                                                                                          
      - "9081:9080"                                                                                                                                 
    depends_on:                                                                                                                                     
      - eureka-server                                                                                                                               
      - postgres-db                                                                                                                                 
      - kafka                                                                                                                                       
    environment:                                                                                                                                    
      - spring.datasource.url=jdbc:postgresql://postgres-db:5432/myRoadAssistance                                                                   
      - spring.datasource.username=postgres                                                                                                         
      - spring.datasource.password=postgres                                                                                                         
      - eureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/                                                                      
      - spring.jpa.hibernate.ddl-auto=update                                                                                                        
      - spring.jpa.show-sql=true                                                                                                                    
      - spring.kafka.bootstrap-servers=kafka:9092                                                                                                   
      - spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer                                                 
      - spring.kafka.producer.value-serializer=org.apache.kafka.common.serialization.StringSerializer                                               
      - spring.kafka.topic.output=my-output-topic                                                                                                   
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
  # UserService Microservice (Consumer)                                                                                                             
  userservice:                                                                                                                                      
    build:                                                                                                                                          
      context: ./UserModuleService                                                                                                                  
      dockerfile: Dockerfile                                                                                                                        
    container_name: userservice                                                                                                                     
    ports:                                                                                                                                          
      - "9070:9070"                                                                                                                                 
    depends_on:                                                                                                                                     
      - eureka-server                                                                                                                               
      - postgres-db                                                                                                                                 
      - kafka                                                                                                                                       
    environment:                                                                                                                                    
      - spring.datasource.url=jdbc:postgresql://postgres-db:5432/myRoadAssistance                                                                   
      - spring.datasource.username=postgres                                                                                                         
      - spring.datasource.password=postgres                                                                                                         
      - eureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/                                                                      
      - spring.jpa.hibernate.ddl-auto=update                                                                                                        
      - spring.jpa.show-sql=true                                                                                                                    
      - spring.kafka.bootstrap-servers=kafka:9092                                                                                                   
      - spring.kafka.consumer.group-id=my-microservices-group                                                                                       
      - spring.kafka.consumer.auto-offset-reset=earliest                                                                                            
      - spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer                                             
      - spring.kafka.consumer.value-deserializer=org.apache.kafka.common.serialization.StringDeserializer                                           
      - spring.kafka.topic.input=my-output-topic                                                                                                    
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
  # VehicleModule Microservice                                                                                                                      
  vehiclemodule:                                                                                                                                    
    build:                                                                                                                                          
      context: ./Vehicle-Module                                                                                                                     
      dockerfile: Dockerfile                                                                                                                        
    container_name: vehiclemodule                                                                                                                   
    ports:                                                                                                                                          
      - "9031:9030"                                                                                                                                 
    depends_on:                                                                                                                                     
      - eureka-server                                                                                                                               
      - postgres-db                                                                                                                                 
    environment:                                                                                                                                    
      - spring.datasource.url=jdbc:postgresql://postgres-db:5432/myRoadAssistance                                                                   
      - spring.datasource.username=postgres                                                                                                         
      - spring.datasource.password=postgres                                                                                                         
      - eureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/                                                                      
      - spring.jpa.hibernate.ddl-auto=update                                                                                                        
      - spring.jpa.show-sql=true                                                                                                                    
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
  # API Gateway (e.g., Spring Cloud Gateway)                                                                                                        
  api-gateway:                                                                                                                                      
    build:                                                                                                                                          
      context: ./api-gateway                                                                                                                        
    container_name: api-gateway                                                                                                                     
    ports:                                                                                                                                          
      - "9000:9000"                                                                                                                                 
    depends_on:                                                                                                                                     
      - eureka-server                                                                                                                               
    environment:                                                                                                                                    
      - eureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/                                                                      
    networks:                                                                                                                                       
      - microservices-network                                                                                                                       
                                                                                                                                                    
networks:                                                                                                                                           
  microservices-network:                                                                                                                            
    driver: bridge                                                                                                                                  
                                                                                                                                                    